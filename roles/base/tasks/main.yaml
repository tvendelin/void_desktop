---
- name: 'xbps upgrade'
  xbps: name=xbps upgrade=yes
  become: true

- name: 'xbps extra repos'
  xbps:
    upgrade: yes
    name:
      - void-repo-nonfree
      - xtools
  become: true

- name: 'xbps upgrade'
  xbps:
    upgrade: yes
  become: true

- name: 'install packages'
  xbps:
    state: latest
    name: '{{item}}'
  loop:
    - curl
    - git
    - rxvt-unicode
    - urxvt-perls
    - unzip
    - xorg
    - alsa-utils
    - base-devel
    - libX11-devel
    - libXft-devel
    - libXinerama-devel
    #  - google-fonts-ttf
    - xkblayout-state
  become: true

- name: 'install davinci dependencies'
  xbps:
    state: latest
    upgrade: yes
    name:
      - nvidia
      - nvidia-opencl
      - libopencv
      - xcb-util
      - xcb-util-wm
      - xcb-util-image
      - xcb-util-keysyms
      - xcb-util-renderutil
      - libxkbcommon-x11
      - glu
  become: true


- name: 'Make dirs'
  file:
    path: '{{suckless_build_root}}'
    state: directory
  loop:
    - '{{suckless_build_root}}'
    - '.fonts'

- name: 'download suckless things'
  get_url:
    url: "{{item['url']}}/{{item['name']}}-{{item['version']}}.tar.gz"
    dest: '/tmp/tars/'
  loop: '{{ suckless_software }}'

- name: 'Unpack suckless'
  unarchive:
    src: "/tmp/tars/{{item['name']}}-{{item['version']}}.tar.gz"
    remote_src: yes
    dest: '{{suckless_build_root}}'
  loop: '{{suckless_software}}'

- name: 'Find config.h'
  find:
    path: '{{suckless_build_root}}'
    patterns:
    - 'config.h'
    recurse: yes
  register: s_config

- debug: msg="{{s_config}}"
- name: 'Remove config.h from sucless dirs'
  file:
    path: "{{item['path']}}"
    state: absent
  loop: "{{s_config['files']}}"

- name: 'Copy patch dir'
  copy:
    src: patches
    dest: "{{suckless_build_root}}/"

- name: 'Register patches'
  find:
    path: "{{suckless_build_root}}/patches"
    patterns:
      - "*.diff"
  register: patches

- name: 'patch suckless'
  debug:
    msg: "{{item['path']}} -- {{suckless_build_root}}/{{item['path'] | basename | replace('.diff', '')}}"
  loop: "{{patches['files']}}"

- name: 'patch suckless'
  shell:
    cmd: "patch < {{item['path'] | quote}}"
    chdir: "{{suckless_build_root}}/{{item['path'] | basename | replace('.diff', '')}}"
  loop: "{{patches['files']}}"

- name: 'Make clean'
  make:
    target: clean
    chdir: "{{suckless_build_root}}/{{item['name']}}-{{item['version']}}"
  loop: '{{suckless_software}}'

- name: 'Make all'
  make:
    target: all
    chdir: "{{suckless_build_root}}/{{item['name']}}-{{item['version']}}"
  loop: '{{suckless_software}}'

- name: 'Make install'
  make:
    target: install
    chdir: "{{suckless_build_root}}/{{item['name']}}-{{item['version']}}"
  loop: '{{suckless_software}}'
  become: true

- name: 'Make .config'
  file:
    path: "~/.config"
    state: directory

- name: 'clone dotfiles'
  git:
    repo: "{{dotfiles_git}}"
    dest: "dotfiles"
    clone: yes

- name: 'Copy dotfiles'
  copy:
    remote_src: true
    src: "dotfiles/{{item}}"
    dest: "{{lookup('env', 'HOME')}}/{{item}}"
  loop:
    - .bashrc
    - .gitconfig
    - .gitconfig-user
    - .gitignore-global
    - .vimrc
    - .Xresources
    - .config
    - .xinitrc

- name: 'Download Meslo Nerd Font'
  get_url:
    url: 'https://github.com/ryanoasis/nerd-fonts/releases/download/v3.2.1/Meslo.zip'
    dest: "{{lookup('env', 'HOME')}}/"

- name: 'Unpack Meslo Nerd Font'
  unarchive:
    remote_src: true
    src: "{{lookup('env', 'HOME')}}/Meslo.zip"
    dest: "{{lookup('env', 'HOME')}}/.fonts/"

- name: 'Install Meslo Nerd Font'
  command:
    argv:
      - fc-cache
      - "-f"
      - "-v"
